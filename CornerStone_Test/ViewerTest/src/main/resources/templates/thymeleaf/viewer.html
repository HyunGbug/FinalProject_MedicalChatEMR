<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OHIF-XNAT Viewer</title>
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
<script	src="https://cdn.jsdelivr.net/npm/cornerstone-math@0.1.6/dist/cornerstoneMath.js"></script>
<script src="https://unpkg.com/cornerstone-core"></script>
<script src="https://unpkg.com/cornerstone-math"></script>
<script src="https://unpkg.com/cornerstone-wado-image-loader"></script>
<script src="https://unpkg.com/cornerstone-tools@4.22.1/dist/cornerstoneTools.js"></script>
<script	src="https://cdn.jsdelivr.net/npm/cornerstone-web-image-loader@2.1.0/dist/cornerstoneWebImageLoader.js"></script>
<script	src="https://cdn.jsdelivr.net/npm/cornerstone-wado-image-loader@3.1.0/dist/cornerstoneWADOImageLoader.js"></script>
<script	src="https://cdn.jsdelivr.net/npm/dicom-parser@1.8.4/dist/dicomParser.js"></script>
<script src="/js/cornerstone.min.js"></script>
<script src="/js/cornerstoneMath.min.js"></script>
<script src="/js/dicomParser.min.js"></script>
<script src="/js/cornerstoneTools.min.js"></script>

<style>
body {
	font-family: Arial, sans-serif;
	margin: 0;
	padding: 0;
	background-color: #1e1e1e;
	color: #fff;
}

.container {
	display: flex;
	flex-direction: column;
	height: 100vh;
}

.header {
	background-color: #B8EDB5;
	padding: 10px;
	display: flex;
	justify-content: space-between;
	align-items: center;
}

.toolbar {
	background-color: #f0f0f0;
	padding: 10px;
	display: flex;
	justify-content: space-between;
	flex-wrap: wrap;
}

.main-content {
	display: flex;
	flex: 1;
}

.left-panel, .right-panel {
	width: 20%;
	background-color: #2a2a2a;
	padding: 10px;
}

.center-panel {
	flex: 1;
	background-color: #000;
	border: 2px solid #ff0000;
	display: flex;
	justify-content: center;
	align-items: center;
	position: relative;
	overflow: hidden;
	cursor: url(/img/cross.cur) 8 8, auto;
}

.footer {
	background-color: #f9f9f9;
	padding: 5px;
	text-align: center;
}

.footer p {
	color: #000;
}

.image-placeholder {
	width: 100%;
	height: 100%;
	background-color: #444;
	display: flex;
	justify-content: center;
	align-items: center;
	font-size: 24px;
	box-sizing: border-box;
}

.btn, .action-button, .interface-button, .prev_button, .next_button,
	.reversal_button, .play-button {
	display: flex;
	align-items: center;
	border: none;
	border-radius: 5px;
	cursor: pointer;
	font-size: 14px;
	transition: background-color 0.3s, box-shadow 0.3s, transform 0.3s;
	user-select: none;
}

.btn, .action-button {
	padding: 10px 20px;
	gap: 8px;
}

.action-buttons {
	display: flex;
	flex-direction: column;
	gap: 10px;
}

.action-button {
	background: #007bff;
	color: white;
	padding: 8px 15px;
}

.action-button i {
	margin-right: 8px;
}

.action-button:hover {
	background-color: #0056b3;
	box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
	transform: translateY(-2px);
}

.interface-toolbar {
	display: flex;
	gap: 10px;
	flex-wrap: wrap;
	margin-top: 10px;
}

.interface-button {
	background: #444;
	color: white;
	padding: 8px 12px;
	font-size: 12px;
}

.interface-button i:nth-of-type(1) {
	margin-right: 6px;
}

.interface-button:hover {
	background-color: #666;
	box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
	transform: translateY(-2px);
}

.interface-button.active {
	background-color: #007bff;
	box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.separator {
	border-bottom: 1px solid #fff;
	margin: 10px 0;
}

.topLeft, .topRight, .bottomLeft, .bottomRight {
	position: absolute;
	color: white;
	padding: 10px;
	z-index: 1;
	font-size: calc(1rem + 1vw);
	max-font-size: 1rem;
}

.topLeft {
	top: 10px;
	left: 10px;
}

.topRight {
	top: 10px;
	right: 10px;
}

.bottomLeft {
	bottom: 10px;
	left: 10px;
}

.bottomRight {
	bottom: 10px;
	right: 10px;
}

.block {
	display: block;
}

.responsive-font {
	font-size: 0.9vw;
}

.playClipModal {
	position: absolute;
	border: 1px solid white;
	background-color: rgb(57, 57, 57);
	bottom: 10px;
	left: 50%;
	border-radius: 10px;
	padding: 10px;
	transform: translateX(-50%);
	display: none;
	z-index: 10;
}

.playClipModal .MuiBox-root, .fpsbutton {
	display: flex;
	cursor: url(/img/cross.cur) 8 8, auto;
	align-items: center;
	justify-content: space-between;
}

.fpsbutton {
	font-size: 15px;
}

.play-button, .speedbutton {
	display: inline-block;
	cursor: url(/img/cross.cur) 8 8, auto;
	user-select: none; margin : 5px;
	background-color: rgb(170, 170, 170);
	border-radius: 5px;
	text-align: center;
	padding: 5px 0px;
	width: 15%;
	margin: 5px;
}

p.fpswords {
	vertical-align: middle;
	text-align: center;
	color: white;
	width: 60%;
	line-height: 30px;
}

.interface-button.disabled {
	background-color: #888;
	cursor: not-allowed;
	opacity: 0.6;
}

.tools_naming {
	margin-right: 6px;
}

.toolModalChildren {
	position: absolute;
	user-select: none;
	border: 1px solid white;
	background-color: #444;
	padding: 10px;
	border-radius: 5px;
	box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
	z-index: 1000;
	display: grid;
	grid-template-columns: repeat(2, 1fr);
	gap: 10px;
	white-space: nowrap;
	display: none;
}

.toolModalChildren div {
	padding: 5px 10px;
	color: white;
	cursor: pointer;
}

.toolModalChildren div:hover {
	background-color: #555;
}

.toolModalChildren.custom-width {
	max-width: 300px;
	width: auto;
}

.interface-button.custom-active {
	background-color: #666;
	box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
	transform: translateY(-2px);
}

.play-button.active {
	background-color: rgba(170, 170, 170);
	color: white;
	border: none;
	box-shadow: none;
}

.play-button:hover {
	background-color: #666;
	box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
	transform: translateY(-2px);
}

.play-button.active:hover {
	background-color: rgba(170, 170, 170);
	box-shadow: none;
	transform: none;
}

.custom-playClipModal {
	align-items: center;
	justify-content: space-between;
	width: 300px; /* 전체 컨테이너의 너비를 조정합니다 */
	padding: 5px;
	height: auto !important;
}

.custom-playClipModal .MuiBox-root {
	display: flex;
	align-items: center;
	justify-content: space-between;
	width: 100%;
}

.custom-playClipModal .play-button, .custom-playClipModal .stop-button,
	.custom-playClipModal .speedbutton {
	width: 40px; /* 버튼 너비 조정 */
	padding: 5px 0;
	margin: 0 2px; /* 버튼 간격 조정 */
	text-align: center;
}

.custom-playClipModal .fpsbutton {
	display: flex;
	align-items: center;
	justify-content: center;
	gap: 2px; /* 좌우 버튼 사이의 간격 조정 */
}

.custom-playClipModal .fpswords {
	margin: 0;
	font-size: 14px;
}
p.copyright{
	color: grey;
}
</style>
</head>

<body>
	<div class="container">
		<header class="header">
			<div class="logo">
				<img src="LOGO.jpg" alt="Logo">
			</div>
		</header>
		<nav class="toolbar">
			<div class="interface-toolbar">
				<button class="interface-button tool-button" data-tool="defaultTool">
					<i class="fas fa-hand-pointer"></i> Default Tool
				</button>
				<button class="interface-button tool-button" data-tool="windowLevel">
					<i class="fas fa-adjust"></i> 윈도우 레벨
				</button>
				<button class="interface-button tool-button" data-tool="invert">
					<i class="fas fa-adjust"></i> 흑백 반전
				</button>
				<button class="interface-button tool-button" data-tool="imageMove">
					<i class="fas fa-arrows-alt"></i> 이동
				</button>
				<button class="interface-button tool-button" data-tool="scrollLoop">
					<i class="fas fa-sync-alt"></i> 스크롤 루프
				</button>
				<button class="interface-button tool-button" data-tool="playClip">
					<i class="fas fa-play"></i> 플레이클립
				</button>
				<button class="interface-button">
					<i class="fas fa-tools"></i> GSPS 도구
				</button>
				<button class="interface-button" data-tool="tools">
					<i class="fa-solid fa-toolbox"></i> <span class="tools_naming">도구</span>
					<i class="fa-solid fa-caret-down"></i>
				</button>
				<!-- 도구 드롭 다운 메뉴 -->
				<div class="toolModalChildren">
					<button class="interface-button tool-button" data-tool="magnify">
						<i class="fa-solid fa-magnifying-glass"></i>돋보기
					</button>
					<button class="interface-button tool-button" data-tool="zoom">
						<i class="fa-solid fa-search-plus"></i>확대
					</button>
					<button class="interface-button tool-button" data-tool="rotate">
						<i class="fa-solid fa-rotate"></i>회전
					</button>
					<button class="interface-button tool-button"
						data-tool="right_rotate">
						<i class="fa-solid fa-rotate-right"></i>오른쪽 회전
					</button>
					<button class="interface-button tool-button"
						data-tool="left_rotate">
						<i class="fa-solid fa-rotate-left"></i>왼쪽 회전
					</button>
					<button class="interface-button tool-button" data-tool="h_flip">
						<i class="fa-solid fa-arrows-alt-h"></i>수평뒤집기
					</button>
					<button class="interface-button tool-button" data-tool="v_flip">
						<i class="fa-solid fa-arrows-alt-v"></i>수직대칭이동
					</button>
					<button class="interface-button tool-button"
						data-tool="interpolation">
						<i class="fa-solid fa-border-all"></i>보간법
					</button>
					<button class="interface-button tool-button" data-tool="reference_line">
						<i class="fa-solid fa-ruler-combined"></i>참조 선
					</button>
				</div>


				<button class="interface-button" data-tool="annotation">
					<i class="fa-solid fa-tag"></i> <span class="tools_naming">주석</span>
					<i class="fa-solid fa-caret-down"></i>
				</button>
				
				<!-- 주석 드롭 다운 메뉴 -->
				<div class="toolModalChildren annotationModal">
					<button class="interface-button tool-button" data-tool="">
						<i class="fa-light fa-angle"></i>
						각도
					</button>
					<button class="interface-button tool-button" data-tool="">
						<i class="fa-solid fa-arrow-right-long"></i>화살표
					</button>
					<button class="interface-button tool-button" data-tool="">
						<i class="fa-solid fa-location-dot"></i>Probe
					</button>
					<button class="interface-button tool-button" data-tool="">
						<i class="fa-solid fa-ruler"></i>길이
					</button>
					<button class="interface-button tool-button" data-tool="">
						<i class="fa-regular fa-square"></i>사각형 그리기
					</button>
					<button class="interface-button tool-button" data-tool="">
						<i class="fa-regular fa-circle"></i>원 그리기
					</button>
					<button class="interface-button tool-button" data-tool="">
						<i class="fa-solid fa-pencil"></i>자율그리기
					</button>
					<button class="interface-button tool-button" data-tool="">
						<i class="fa-solid fa-border-all"></i>bidirectional
					</button>
					<button class="interface-button tool-button">
						<i class="fa-solid fa-ruler-combined"></i>콥 각도
					</button>
					<button class="interface-button tool-button">
						<i class="fa-regular fa-comment"></i>텍스트 마커
					</button>
					<button class="interface-button tool-button">
						<i class="fa-solid fa-eraser"></i>선택 삭제
					</button>
				</div>
				
				<button class="interface-button">
					<i class="fas fa-undo"></i> <span class="tools_naming">재설정</span> <i
						class="fa-solid fa-caret-down"></i>
				</button>
				<button class="interface-button">
					<i class="fas fa-film"></i> <span class="tools_naming">Series</span>
					<i class="fa-solid fa-caret-down"></i>
				</button>
				<button class="interface-button" data-tool="img_layout">
					<i class="fas fa-th"></i> <span class="tools_naming">이미지
						레이아웃</span> <i class="fa-solid fa-caret-down"></i>
				</button>
				<button class="interface-button">
					<i class="fas fa-save"></i> 주석저장 DICOM
				</button>
			</div>
		</nav>
		<main class="main-content">
			<aside class="left-panel">
				<h3>TEST</h3>
				<div class="separator"></div>
				<p>RS-5293-132</p>
				<p>RS-5293-132</p>
				<div class="action-buttons">
					<button class="action-button">
						<i class="fas fa-download"></i> DICOM 다운로드
					</button>
					<button class="action-button">
						<i class="fas fa-image"></i> JPG 다운로드
					</button>
					<button class="action-button">
						<i class="fas fa-trash"></i> 삭제하기
					</button>
				</div>
			</aside>

			<section class="center-panel">
				<!-- playClipModal 추가 -->
				<div class="playClipModal custom-playClipModal">
					<div class="MuiBox-root">
						<button class="tool-button play-button" data-tool="start_button">
							<i class="fa-solid fa-play"></i>
						</button>
						<div class="fpsbutton">
							<button class="speedbutton">
								<i class="fa-solid fa-angle-left"></i>
							</button>
							<p class="fpswords"></p>
							<button class="speedbutton">
								<i class="fa-solid fa-angle-right"></i>
							</button>
						</div>
						<button class="tool-button play-button" data-tool="stop_button">
							<i class="fa-solid fa-stop"></i>
						</button>
					</div>
				</div>

				<div class="topLeft responsive-font">
					<span class="block imagePname"></span>
					<span class="block imageNumber"></span>
				</div>
				<div class="topRight responsive-font">
					<span class="block">test</span>
				</div>
				<div class="bottomLeft responsive-font">
					<span class="block">test</span>
				</div>
				<div class="bottomRight responsive-font">
					<span class="block wwwc"></span>
				</div>
				<div id="dicomImage" class="image-placeholder"></div>
			</section>

			<aside class="right-panel">
				<h3>Contour-based ROIs</h3>
				<p>In-Progress Contour Collections</p>
				<ul>
					<li>ISOCENTRE</li>
					<li>NORM</li>
					<li>CTV</li>
					<li>Heart</li>
					<li>Both Lungs</li>
				</ul>
			</aside>
		</main>
		<footer class="footer">
			<!-- <p>Zoom: 172% | W: 360 L: 60 | Lossless / Uncompressed</p> -->
			<p class="copyright">Icons by fontawesome</p>
		</footer>
	</div>

	<script th:inline="javascript">
//cornerstone 관련 설정
console.log("Setting external libraries");
cornerstoneWADOImageLoader.external.cornerstone = cornerstone;
cornerstoneWebImageLoader.external.cornerstone = cornerstone;
cornerstoneTools.external.cornerstone = cornerstone;
cornerstoneTools.external.Hammer = Hammer;
cornerstoneWADOImageLoader.external.dicomParser = dicomParser;

// 이미지 로더 등록
console.log("Configuring image loader");
cornerstoneWADOImageLoader.configure({});

const element = document.getElementById('dicomImage');
const playButton = document.querySelector('.playClipModal .fa-play').parentElement;
const stopButton = document.querySelector('.playClipModal .fa-stop').parentElement;
const fileId = [[${fileId}]]; // 서버에서 전달되는 fileId 변수
const fileUrl = `/dicom?id=${fileId}`;
const customCursor = 'url(/img/cross.cur) 8 8, auto'; // 전역 변수로 설정
const toolButton = document.querySelector('.interface-button i.fa-toolbox').parentElement;
const toolModal = toolButton.nextElementSibling;
const imageScrollLoopButton = document.querySelector('[data-tool="scrollLoop"]');
const imageLayoutButton = document.querySelector('[data-tool="img_layout"]');
const toolsButton = document.querySelector('[data-tool="tools"]');
const playClipButton = document.querySelector('[data-tool="playClip"]');
const playClipModal = document.querySelector('.playClipModal');
const annotationButton = document.querySelector('[data-tool="annotation"]');
const annotationModal = document.querySelector('.annotationModal');

let isPlayClipActive = false;
let currentImageIndex = 0;
let currentViewport = null; // 현재 뷰포트를 저장하기 위한 변수
let isScrollLoopActive = false; // 스크롤 루프 기능 활성화 상태 저장 변수
let stopClipPlaybackGlobal;  // 전역 변수로 함수 참조를 저장할 변수
let isZoomActive = false;
let originalImageSize = null;
let isPlaying = false; // 클립 재생 상태
let playInterval; // 클립 재생을 위한 인터벌
let fps = 20; // 초기 FPS 값

// 도구 버튼 클릭시 드롭다운 표시 이벤트
toolButton.addEventListener('click', function (e) {
    e.stopPropagation(); // 이벤트 버블링 방지

    // toolModal 위치 조정 (버튼 클릭 시에만 위치 설정)
    const buttonRect = toolButton.getBoundingClientRect();
    toolModal.style.top = `${buttonRect.bottom}px`;
    toolModal.style.left = `${buttonRect.left}px`;

    // 메뉴 표시/숨김 토글
    if (toolModal.style.display === 'none' || !toolModal.style.display) {
        toolModal.classList.add('custom-width'); // 너비 조절을 위한 클래스 추가
        toolModal.style.display = 'grid';
        toolButton.classList.add('custom-active'); // 버튼 활성화 효과
    } else {
        hideToolMenu();
    }
});

//주석 버튼 클릭 시 드롭다운 메뉴 표시/숨기기
annotationButton.addEventListener('click', function (e) {
    e.stopPropagation(); // 이벤트 버블링 방지

    const buttonRect = annotationButton.getBoundingClientRect();
    annotationModal.style.top = `${buttonRect.bottom}px`;
    annotationModal.style.left = `${buttonRect.left}px`;

    // 메뉴 표시/숨김 토글
    if (annotationModal.style.display === 'none' || !annotationModal.style.display) {
        annotationModal.classList.add('custom-width'); // 너비 조절을 위한 클래스 추가
        annotationModal.style.display = 'grid';
        annotationButton.classList.add('custom-active'); // 버튼 활성화 효과
    } else {
    	hideAnnotationMenu();
    }
});

function hideToolMenu(){
    toolModal.style.display = 'none';
    toolModal.classList.remove('custom-width'); // 숨길 때 클래스 제거
    toolButton.classList.remove('custom-active'); // 버튼 활성화 효과 제거
}

function hideAnnotationMenu(){
    annotationModal.style.display = 'none';
    annotationModal.classList.remove('custom-width'); // 숨길 때 클래스 제거
    annotationButton.classList.remove('custom-active'); // 버튼 활성화 효과 제거
}

// 도구 버튼 또는 드롭다운 메뉴에서 마우스가 벗어났을 때 메뉴 숨김
toolButton.addEventListener('mouseleave', function (e) {
    if (!toolModal.contains(e.relatedTarget)) {
        toolModal.style.display = 'none';
        toolButton.classList.remove('custom-active');
    }
});

toolModal.addEventListener('mouseleave', function (e) {
    if (!toolButton.contains(e.relatedTarget)) {
        toolModal.style.display = 'none';
        toolButton.classList.remove('custom-active');
    }
});

//주석 버튼 또는 드롭다운 메뉴에서 마우스가 벗어났을 때 메뉴 숨김
annotationButton.addEventListener('mouseleave', function (e) {
    if (!annotationModal.contains(e.relatedTarget)) {
    	annotationModal.style.display = 'none';
        annotationButton.classList.remove('custom-active');
    }
});

annotationModal.addEventListener('mouseleave', function (e) {
    if (!annotationButton.contains(e.relatedTarget)) {
    	annotationModal.style.display = 'none';
        annotationButton.classList.remove('custom-active');
    }
});

// Cornerstone 요소 활성화
console.log("Enabling cornerstone element");
cornerstone.enable(element); // 요소를 활성화합니다.

// 모든 도구 비활성화 함수
function disableAllTools() {
    cornerstoneTools.wwwc.disable(element);
    cornerstoneTools.pan.disable(element);
    cornerstoneTools.zoom.disable(element);
    cornerstoneTools.length.disable(element);
    cornerstoneTools.magnify.disable(element);
    cornerstoneTools.rotate.disable(element);
    cornerstoneTools.mouseInput.disable(element);
    cornerstoneTools.mouseWheelInput.disable(element);
    deactivateZoom();
    isScrollLoopActive = false;
}

// 도구 활성화 함수 (기존 코드)
function enableAllTools(){
    cornerstoneTools.mouseInput.enable(element);
    cornerstoneTools.mouseWheelInput.enable(element);
}

// 활성 버튼 설정 (기존 코드)
function setActiveButton(button) {
    document.querySelectorAll('.interface-button').forEach(btn => {
        if (btn !== imageScrollLoopButton && btn !== playClipButton) {
            btn.classList.remove('active');
            btn.classList.remove('custom-active');
        }
    });
    button.classList.add('active');
    removeWindowLevelMouseListener();
}

// 도구 버튼 css 설정
function setActiveToolsButton(button) {
    document.querySelectorAll('.interface-button').forEach(btn => {
        if (btn !== imageScrollLoopButton && btn !== playClipButton) {
            btn.classList.remove('custom-active');
        }
    });
    button.classList.add('custom-active');
    removeWindowLevelMouseListener();
}

// 윈도우 레벨 마우스 리스너 추가 함수 (기존 코드)
function addWindowLevelMouseListener() {
    element.addEventListener('mousedown', windowLevelMouseDownHandler);
}

// 윈도우 레벨 마우스 리스너 제거 함수 (기존 코드)
function removeWindowLevelMouseListener() {
    element.removeEventListener('mousedown', windowLevelMouseDownHandler);
}

// 윈도우 레벨 마우스 핸들러 (기존 코드)
function windowLevelMouseDownHandler(e) {
    let lastX = e.pageX;
    let lastY = e.pageY;

    function mouseMoveHandler(e) {
        const deltaX = e.pageX - lastX;
        const deltaY = e.pageY - lastY;
        lastX = e.pageX;
        lastY = e.pageY;

        let viewport = cornerstone.getViewport(element);
        viewport.voi.windowWidth += (deltaX / viewport.scale);
        viewport.voi.windowCenter += (deltaY / viewport.scale);
        cornerstone.setViewport(element, viewport);

        document.querySelector('.wwwc').textContent = Math.round(viewport.voi.windowWidth)
            + "/" + Math.round(viewport.voi.windowCenter);
    }

    function mouseUpHandler() {
        document.removeEventListener('mousemove', mouseMoveHandler);
        document.removeEventListener('mouseup', mouseUpHandler);
    }

    document.addEventListener('mousemove', mouseMoveHandler);
    document.addEventListener('mouseup', mouseUpHandler);
}

// 확대 이벤트 함수
function zoomMouseDownHandler(e) {
    const mouseButton = e.which;
    let lastY = e.pageY;
    
    function mouseMoveHandler(e) {
        const deltaY = e.pageY - lastY;
        lastY = e.pageY;
        
        if(mouseButton === 1){
        let viewport = cornerstone.getViewport(element);
        viewport.scale += (deltaY / 100);
        cornerstone.setViewport(element, viewport);
        }
    }

    function mouseUpHandler() {
        document.removeEventListener('mousemove', mouseMoveHandler);
        document.removeEventListener('mouseup', mouseUpHandler);
    }

    document.addEventListener('mousemove', mouseMoveHandler);
    document.addEventListener('mouseup', mouseUpHandler);
}

// Zoom 기능 비활성화 함수
function deactivateZoom() {
    if (isZoomActive) {
        element.removeEventListener('mousedown', zoomMouseDownHandler);
        isZoomActive = false;
    }
}

// 기본 도구 활성화 설정 및 이벤트 핸들러 설정
document.querySelectorAll('.tool-button').forEach(button => {
    button.addEventListener('click', (event) => {
        const tool = event.currentTarget.getAttribute('data-tool');
        const viewport = cornerstone.getViewport(element);
        switch(tool) {
            case 'defaultTool':
                setActiveButton(event.currentTarget);
                disableAllTools();
                document.querySelector('.center-panel').style.cursor = customCursor;
                break;

            case 'windowLevel':
                setActiveButton(event.currentTarget);
                disableAllTools();
                enableAllTools();
                addWindowLevelMouseListener();
                break;

            case 'invert':
                viewport.invert = !viewport.invert;
                cornerstone.setViewport(element, viewport);
                break;

            case 'imageMove':
                setActiveButton(event.currentTarget);
                disableAllTools();
                enableAllTools();
                cornerstoneTools.pan.activate(element, 1);
                element.addEventListener('cornerstoneimagerendered', () => {
                    currentViewport = cornerstone.getViewport(element);
                });
                break;

            case 'scrollLoop':
                isScrollLoopActive = !isScrollLoopActive; // 스크롤 루프 기능 활성화/비활성화 토글
                if (isScrollLoopActive) {
                    event.currentTarget.classList.add('active'); // 활성화된 상태로 표시
                } else {
                    event.currentTarget.classList.remove('active'); // 버튼 활성화 표시 해제
                }
                break;
            case 'playClip':
                isPlayClipActive = !isPlayClipActive;
                if (isPlayClipActive) {
                    document.querySelector('.fpswords').textContent = `FPS : ${fps}`;
                    playClipModal.style.display = 'block';
                    event.currentTarget.classList.add('active'); // 버튼 활성화 표시
                    playButton.classList.remove('active');
                    stopButton.classList.add('active');
                    imageScrollLoopButton.disabled = true; // 스크롤 루프 버튼 비활성화
                    imageScrollLoopButton.classList.add('disabled');
                    imageLayoutButton.disabled = true;
                    imageLayoutButton.classList.add('disabled');
                } else {
                    playClipModal.style.display = 'none';
                    event.currentTarget.classList.remove('active'); // 버튼 활성화 표시 해제
                    imageScrollLoopButton.disabled = false; // 스크롤 루프 버튼 활성화
                    imageScrollLoopButton.classList.remove('disabled'); // 비활성화 상태 시각적 표시 해제
                    imageLayoutButton.disabled = false;
                    imageLayoutButton.classList.remove('disabled');
                    
                    // 클립 재생 멈추기
					if (typeof stopClipPlaybackGlobal !== 'undefined') {
    					stopClipPlaybackGlobal();  // 전역 변수에 저장된 함수 호출
					}
                }
                break;

            // 다른 버튼을 눌렀을 때 playClip 버튼이 활성화 상태를 유지하는 부분 추가
            document.querySelectorAll('.tool-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    if (!isPlayClipActive) {
                        document.querySelector('[data-tool="playClip"]').classList.remove('active');
                    }
                });
            });
	            // 도구 관련 버튼 이벤트들
            case 'magnify':
            	setActiveButton(toolsButton);
            	setActiveToolsButton(event.currentTarget);
            	disableAllTools();
            	enableAllTools();
            	
            	const magnifyOptions = {
            		    magnifySize: 300, // 돋보기 크기를 설정 (픽셀 단위)
            		    magnificationLevel: 2.5, // 확대 배율 설정
            		};
            	cornerstoneTools.magnify.setConfiguration(magnifyOptions);
            	cornerstoneTools.magnify.activate(element, 1);
            	
                // 마우스 이벤트 추가
                element.addEventListener('mousedown', hideCursor);
                element.addEventListener('mouseup', showCursor);
                
            	hideToolMenu();
            	break;
            case 'zoom':
            	setActiveButton(toolsButton);
            	setActiveToolsButton(event.currentTarget);
            	disableAllTools();
                isZoomActive = true; // Zoom 기능 활성화
                element.addEventListener('mousedown', zoomMouseDownHandler); // 마우스 다운 이벤트 추가
            	hideToolMenu();
            	break;
            case 'rotate':
            	setActiveButton(toolsButton);
            	setActiveToolsButton(event.currentTarget);
            	disableAllTools();
            	enableAllTools();
            	
            	cornerstoneTools.rotate.activate(element,1);
            	
            	hideToolMenu();
            	break;
            case 'left_rotate':
                viewport.rotation-=90;
                cornerstone.setViewport(element, viewport);
                hideToolMenu();
            	break;
            case 'right_rotate':
                viewport.rotation+=90;
                cornerstone.setViewport(element, viewport);
                hideToolMenu();
            	break;
            case 'h_flip':
            	viewport.hflip = !viewport.hflip;
                cornerstone.setViewport(element, viewport);
                hideToolMenu();
            	break;
            case 'v_flip':
                viewport.vflip = !viewport.vflip;
                cornerstone.setViewport(element, viewport);
                hideToolMenu();
            	break;
            case 'interpolation':
                viewport.pixelReplication = !viewport.pixelReplication;
                cornerstone.setViewport(element, viewport);
                hideToolMenu();
            	break;
            case 'reference_line':
                setActiveToolsButton(event.currentTarget);
            	disableAllTools();
            	enableAllTools();
            	cornerstoneTools.relatedTarget.activate(element,1);
            	hideToolMenu();
            	break;
        }
        
        if (tool !== 'magnify') {
            element.removeEventListener('mousedown', hideCursor);
            element.removeEventListener('mouseup', showCursor);
            element.style.cursor = customCursor; // 기본 커서로 복귀
        }
    });
});

// 커서 숨김 함수
function hideCursor() {
    element.style.cursor = 'none';
}

// 커서 표시 함수
function showCursor() {
    element.style.cursor = customCursor;
}

// 기본 도구 활성화 설정
setActiveButton(document.querySelector('[data-tool="defaultTool"]'));
document.querySelector('.center-panel').style.cursor = customCursor;


// /dicom 엔드포인트 호출하여 DICOM 데이터 가져오기
fetch(fileUrl)
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json(); // 데이터를 JSON으로 받음
    })
    .then(fileDataList => {
        console.log("Fetched DICOM data:", fileDataList);
        if (!Array.isArray(fileDataList) || fileDataList.length === 0) {
            throw new Error('No DICOM files found');
        }

        function loadAndDisplayImage(index) {
            const fileData = fileDataList[index];
            if (!fileData || !fileData.file_data) {
                throw new Error(`Missing file_data at index ${index}`);
            }

            // Base64 디코딩 후 Blob 생성
            const byteCharacters = atob(fileData.file_data); // Base64 디코딩
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);

            const fileBlobUrl = URL.createObjectURL(new Blob([byteArray]));
            const imageId = 'wadouri:' + fileBlobUrl;

            cornerstone.loadImage(imageId).then(function(image) {
                // 처음 이미지를 로드할 때 원본 크기를 기억합니다.
                if (!originalImageSize) {
                    originalImageSize = { width: image.columns, height: image.rows };
                }

                if (currentViewport) {
                    cornerstone.displayImage(element, image);
                    cornerstone.setViewport(element, currentViewport);
                } else {
                    cornerstone.displayImage(element, image);
                    currentViewport = cornerstone.getViewport(element);
                }

                currentViewport = cornerstone.getViewport(element);
                updateImageNumber();

                const viewport = cornerstone.getViewport(element);
                document.querySelector('.wwwc').textContent = Math.round(viewport.voi.windowWidth) + "/" + Math.round(viewport.voi.windowCenter);
            }).catch(function(err) {
                console.error('Error loading image:', err);
            });
        }

        function updateImageNumber() {
            const imageNumberElement = document.querySelector('.imageNumber');
            const imagePnameElement = document.querySelector('.imagePname');
            imageNumberElement.textContent = `${currentImageIndex + 1}/${fileDataList.length}`;
            imagePnameElement.textContent = fileDataList[0]["pname"];
        }

        function resizeImage() {
            console.log("Resizing image");

            // 현재 뷰포트가 있으면 복사하고, 없으면 새로운 뷰포트를 생성
            let updatedViewport = currentViewport ? {...currentViewport} : cornerstone.getDefaultViewportForImage(element, image);

            // 현재 뷰포트의 스케일을 조정 (원본 이미지 크기를 기준으로)
            if (originalImageSize) {
                const containerWidth = element.clientWidth;
                const containerHeight = element.clientHeight;
                const scale = Math.min(containerWidth / originalImageSize.width, containerHeight / originalImageSize.height, 1);

                // 기존의 뷰포트 값을 유지하면서 scale만 업데이트
                updatedViewport.scale = scale;
            }

            // 뷰포트 설정 적용
            cornerstone.setViewport(element, updatedViewport);
            cornerstone.resize(element, true);
        }

        loadAndDisplayImage(currentImageIndex);

        // 브라우저 크기 변경 시에만 resizeImage 호출
        window.addEventListener('resize', () => {
            resizeImage();
        });

        // 휠 이벤트 추가
        const wheelEvents = ['mousewheel', 'DOMMouseScroll'];
        wheelEvents.forEach((eventType) => {
            element.addEventListener(eventType, function (e) {
                e.preventDefault();

                if (!currentViewport) {
                    currentViewport = cornerstone.getViewport(element);
                }

                if (e.wheelDelta > 0 || e.detail < 0) {
                    if (currentImageIndex < fileDataList.length - 1) {
                        currentImageIndex++;
                    } else if (isScrollLoopActive) {
                        currentImageIndex = 0;
                    }
                } else {
                    if (currentImageIndex > 0) {
                        currentImageIndex--;
                    } else if (isScrollLoopActive) {
                        currentImageIndex = fileDataList.length - 1;
                    }
                }

                loadAndDisplayImage(currentImageIndex);
                updateImageNumber();

                return false;
            });
        });

		// 클립 재생 함수
		function startClipPlayback() {
    		if (isPlaying) clearInterval(playInterval); // 기존 인터벌을 삭제하여 FPS 변경을 반영
    		isPlaying = true;
    		playInterval = setInterval(() => {
        		currentImageIndex = (currentImageIndex + 1) % fileDataList.length;
        		loadAndDisplayImage(currentImageIndex);
    		}, 1000 / fps);
		}

        // 클립 정지 함수
        function stopClipPlayback() {
            clearInterval(playInterval);
            isPlaying = false;
        }
        
        // 전역 변수에 할당하여 외부에서 접근 가능하게 설정
        stopClipPlaybackGlobal = stopClipPlayback;

     // FPS 조정 버튼 클릭 이벤트
        document.querySelector('.fpsbutton').addEventListener('click', (event) => {
            if (event.target.closest('.speedbutton')) {
                const button = event.target.closest('.speedbutton');
                const direction = button.querySelector('i').classList.contains('fa-angle-left') ? 'decrease' : 'increase';

                if (direction === 'decrease' && fps > 1) {
                    fps--;
                } else if (direction === 'increase' && fps < 100) {
                    fps++;
                }
                
                document.querySelector('.fpswords').textContent = `FPS : ${fps}`;
                
                if (isPlaying) {
                    startClipPlayback(); // FPS 변경에 따라 클립 재생을 업데이트
                }
            }
        });

        // 버튼 이벤트 설정
        playButton.addEventListener('click', function() {
            if (!playButton.classList.contains('active')) {
                startClipPlayback();
                playButton.classList.add('active');
                stopButton.classList.remove('active');
            }
        });

        // stop 버튼 클릭 이벤트
        stopButton.addEventListener('click', function() {
            if (!stopButton.classList.contains('active')) {
                stopClipPlayback();
                stopButton.classList.add('active');
                playButton.classList.remove('active');
            }
        });

    })
    .catch(error => {
        console.error('Error fetching DICOM data:', error);
    });
</script>

</body>
</html>
